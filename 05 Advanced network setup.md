#Raspbian master image creation
##Part 05 - Advanced network setup
###Image requirements
Uses the image created in 4 - Advanced user security setup
###Copy a master image to a new SD card (Optional)
1. Insert a SD card into your computer
1. Find out the ID of the SD Card
	`diskutil list` => /dev/disk1
1. Unmount the SD Card
	`diskutil unmountDisk /dev/disk1`
1. Copy the image for the card
	`sudo dd bs=4m if=/Users/brianmcmillan/Documents/systemimages/raspberrypi/master/raspbian_<image>.img of=/dev/rdisk1`
1. Unmount the SD Card
`diskutil unmountDisk /dev/disk1`

---

###Adding external / backup DNS resolution
1. Open a terminal window on your Mac
1. SSH into the RPi. This will open a new terminal window to the RPi.
	`ssh admin@192.168.0.100`
1. Switch to the root user 
`sudo -i`
1. Update the network configuration file to add the Google public DNS servers to the end of the file

```
sudo cat <<EOT > /etc/resolv.conf
#################################################
## RPi DNS configuration file
#################################################
## FILE NAME resolv.conf
## FILE LOCATION /etc/
## SCM LOCATION <path to git location>
## MAINTAINER <brian.mcmillan.architect@gmail.com>
## CREATE DATE <2015-12-11>
## LAST MODIFIED <2015-12-11>
## INFO 
#################################################
# Generated by resolvconf
nameserver 192.168.0.1

#Google public name servers
nameserver 8.8.8.8
nameserver 8.8.4.4

EOT
```

###Configuring Network Time Protocol (NTP)
1. Update the network configuration file to add the Google public DNS servers to the end of the file

```
sudo cat <<EOT > /etc/ntp.conf
#################################################
## RPi DNS configuration file
#################################################
## FILE NAME ntp.conf
## FILE LOCATION /etc/
## SCM LOCATION <path to git location>
## MAINTAINER <brian.mcmillan.architect@gmail.com>
## CREATE DATE <2015-12-11>
## LAST MODIFIED <2015-12-11>
## INFO 
#################################################
# /etc/ntp.conf, configuration for ntpd; see ntp.conf(5) for help

driftfile /var/lib/ntp/ntp.drift

# Enable this if you want statistics to be logged.
#statsdir /var/log/ntpstats/

statistics loopstats peerstats clockstats
filegen loopstats file loopstats type day enable
filegen peerstats file peerstats type day enable
filegen clockstats file clockstats type day enable

# You do need to talk to an NTP server or two (or three).
#server ntp.your-provider.example

# pool.ntp.org maps to about 1000 low-stratum NTP servers.  Your server will
# pick a different set every time it starts up.  Please consider joining the
# pool: <http://www.pool.ntp.org/join.html>
server 0.debian.pool.ntp.org iburst
server 1.debian.pool.ntp.org iburst
server 2.debian.pool.ntp.org iburst
server 3.debian.pool.ntp.org iburst

# Access control configuration; see /usr/share/doc/ntp-doc/html/accopt.html for
# details.  The web page <http://support.ntp.org/bin/view/Support/AccessRestrictions>
# might also be helpful.
#
# Note that "restrict" applies to both servers and clients, so a configuration
# that might be intended to block requests from certain clients could also end
# up blocking replies from your own upstream servers.

# By default, exchange time with everybody, but don't allow configuration.
restrict -4 default kod notrap nomodify nopeer noquery
restrict -6 default kod notrap nomodify nopeer noquery

# Local users may interrogate the ntp server more closely.
restrict 127.0.0.1
restrict ::1

# Clients from this (example!) subnet have unlimited access, but only if
# cryptographically authenticated.
#restrict 192.168.123.0 mask 255.255.255.0 notrust


# If you want to provide time to your local subnet, change the next line.
# (Again, the address is an example only.)
#broadcast 192.168.123.255

# If you want to listen to time broadcasts on your local subnet, de-comment the
# next lines.  Please do this only if you trust everybody on the network!
#disable auth
#broadcastclient

EOT
```

###Setting a static IP Address (Optional) 
1. Update the dhcp configuration file to add a static IP address to the end of the configuration file.

```
sudo cat <<EOT > /etc/dhcpcd.conf
#################################################
## RPi DNS configuration file
#################################################
## FILE NAME dhcpcd.conf
## FILE LOCATION /etc/
## SCM LOCATION <path to git location>
## MAINTAINER <brian.mcmillan.architect@gmail.com>
## CREATE DATE <2015-12-11>
## LAST MODIFIED <2015-12-11>
## INFO 
#################################################
# A sample configuration for dhcpcd.
# See dhcpcd.conf(5) for details.

# Allow users of this group to interact with dhcpcd via the control socket.
#controlgroup wheel

# Inform the DHCP server of our hostname for DDNS.
hostname

# Use the hardware address of the interface for the Client ID.
clientid
# or
# Use the same DUID + IAID as set in DHCPv6 for DHCPv4 ClientID as per RFC4361.
#duid

# Persist interface configuration when dhcpcd exits.
persistent

# Rapid commit support.
# Safe to enable by default because it requires the equivalent option set
# on the server to actually work.
option rapid_commit

# A list of options to request from the DHCP server.
option domain_name_servers, domain_name, domain_search, host_name
option classless_static_routes
# Most distributions have NTP support.
option ntp_servers
# Respect the network MTU.
# Some interface drivers reset when changing the MTU so disabled by default.
#option interface_mtu

# A ServerID is required by RFC2131.
require dhcp_server_identifier

# Generate Stable Private IPv6 Addresses instead of hardware based ones
slaac private

# A hook script is provided to lookup the hostname if not set by the DHCP
# server, but it should not be run by default.
nohook lookup-hostname

# Setup a static ip address
#static
#interface eth0
#static ip_address=192.168.0.100/24
#static routers=192.168.0.1
#static domain_name_servers=192.168.0.1

EOT
```	

###Restart the networking service
`sudo /etc/init.d/networking restart`
	
###Create a dynamically generated hostname
1. Lookup the hostname
`echo $HOSTNAME` => `raspberrypi`
1. Generate a new hostname
`GEO=$"us1" && OLD=$HOSTNAME && SEQ=$(cat /dev/urandom | tr -cd 'abcdfghjkmnprstvwxy0-9' | head -c 5) && sudo sed -i "s/$OLD/$GEO-$SEQ/" /etc/hostname && sudo sed -i "s/$OLD/$GEO-$SEQ/g" /etc/hosts && sudo reboot`
1. SSH into the RPi again with the IP Address
	`ssh admin@192.168.0.11`  
	The console prompt should now read something like 	`admin@us1-bgwgc ~ $`
1. Lookup new hostname
	`echo $HOSTNAME` => `us1-bgwgc`
	
###Setup system auto discovery (Bonjour, mDNS, Zeroconf)
1. SSH into the RPi.
`ssh admin@192.168.0.11`
1. Download and install Avahi
`sudo apt-get install avahi-daemon` 
1. Log out
`exit`
1. Log in with the local host name
`ssh admin@us1-bgwgc.local`

##Shutting down safely
`sudo shutdown -h now` or `sudo halt`
`sudo shutdown -r now` or `sudo reboot`

##Backing up the SD Card / Create the master image 
1. With power off to the RPi, remove the SD card.
1. Insert a SD card into your computer
1. Open a terminal window
1. Find out the ID of the SD Card
`diskutil list` => /dev/disk1
1. Copy the image on the card to the computer
`sudo dd bs=4m if=/dev/rdisk1 of=/Users/brianmcmillan/Documents/systemimages/raspberrypi/master/raspbian_lite_05.img`
1. Unmount the SD Card
`diskutil unmountDisk /dev/disk1`

This will take some time (10-30 min.) and if you are impatient, check the status with `[CTRL] + t`.

This image can be used to bootstrap a RPi without having to reconfigure an image from scratch.